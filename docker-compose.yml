version: '3.8'

services:
  codex:
    image: codex-container:${CODEX_VERSION}
    build:
      context: .
      dockerfile: Dockerfile
      args:
        CODEX_VERSION: ${CODEX_VERSION}
    container_name: ${CODEX_CONTAINER_NAME:-codex-container-runtime}

    # Interactive mode
    stdin_open: true
    tty: true

    # Security defaults (sudo disabled unless explicitly allowed)
    security_opt:
      - no-new-privileges:true

    # Volumes
    volumes:
      # Mount current directory as workspace
      - .:/workspace
      # Persist configuration
      - codex-config:/config
      # Persist npm global packages
      - codex-npm-global:/home/codex/.npm-global
      # Persist codex authentication (default: stored in /config/codex via entrypoint)
      # - ${HOME}/.codex:/home/codex/.codex
      # Optional: Mount Docker socket for Docker-in-Docker
      # - /var/run/docker.sock:/var/run/docker.sock

    # Environment variables
    environment:
      - NODE_ENV=production
      - CODEX_CONTAINER=true
      - USER_UID=${USER_UID:-1000}
      - USER_GID=${USER_GID:-1000}
      - ALLOW_SUDO=${ALLOW_SUDO:-false}

    # Working directory
    working_dir: /workspace

    # User
    user: codex

    # Network
    # Use host network for OAuth
    network_mode: host

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Restart policy
    restart: unless-stopped

    # Command
    command: bash

# Volumes
volumes:
  codex-config:
    name: codex-config
  codex-npm-global:
    name: codex-npm-global

# Networks
networks:
  codex-network:
    name: codex-network
    driver: bridge
